var gmFilter = function (b, cityjson, sortjson) {
    this.goclose = false;
    this.defaults = {
        city: cityjson,
        category: sortjson,
        sort: [{
            id: 1,
            param: "sort",
            name: "销量",
            value: "salesnum"
        },
            {
                id: 2,
                param: "sort",
                name: "人气",
                value: "view"
            },
            {
                id: 3,
                param: "sort",
                name: "好评",
                value: "pingfen"
            },
            {
                id: 4,
                param: "sort",
                name: "新品",
                value: "new"
            },
            {
                id: 5,
                param: "sort",
                name: "推荐",
                value: "besa"
            },
            {
                id: 6,
                param: "sort",
                name: "热销",
                value: "hot"
            },
            {
                id: 7,
                param: "sort",
                name: "价格",
                value: "shop_price",
                sub_categories: [{
                    id: 8,
                    param: "sort",
                    name: "从高到低",
                    value: "shop_price"
                },
                    {
                        id: 9,
                        param: "sort_asc",
                        name: "从低到高",
                        value: "asc"
                    }]
            }],
        ch: "",
        obj: $("#headerfilter-bar"),
        max_height: parseInt($(window).height() * 4 / 5, 10),
        selected: {
            city: "",
            dist_group: "",
            cateogry: "",
            tag: "",
            sort: ""
        }
    };
    this.options = $.extend(this.defaults, b);
    this.obj = this.options.obj;
    var a = this;
    a._init();
    a.obj.find("#dropdown-scroller .dropdown-list a").bind("click", function (c) {
        if (a.active_type) {
            if (!$(this).parent("li").is(".active")) {
                $(this).trigger("active")
            }
            if ($(this).data("has-sub")) {
                c.preventDefault()
            } else {}
        }
    }).bind("active", function () {
        var d = $(this).data(a.active_type + "-id");
        a.selected[a.active_type] = d;
        a.obj.find("#dropdown-scroller .dropdown-list li.active").removeClass("active");
        $(this).parent("li").addClass("active");
        if ($(this).data("has-sub")) {
            var c = $.grep(a.options[a.active_type], function (e) {
                return e.id === d
            })[0];
            if (c.sub_categories) {
                a._renderDropdownSubList(c.sub_categories);
                a.has_sub = true
            }
        } else {
            a._renderDropdownSubList(null);
            a.has_sub = false
        }
        a._resizeDropdownList()
    });
    a.obj.find(".nav li").bind("click", function () {
        var c = a.obj.find(".nav li.active");
        if (this == c[0]) {
            a.close()
        } else {
            if (c[0]) {
                a._reset()
            }
            $(this).trigger("active")
        }
    }).bind("active", function () {
        var c = $(this).attr("class").replace(/.*(city|category|sort).*/, "$1");
        a.active(c);
        //
        var hash = window.location.hash;
        var href = window.location.href.replace(new RegExp(hash,"g"), "");
        window.location.href = href + '#gm/' + c;
    });
    this.hashchange = function(){
        var hash = window.location.hash;
        if (!/^\#gm\//.test(hash)) {
            a.close();
        }else{
            var evecl = $("#headerfilter-bar").find("li.active").attr("class");
            var ehash = hash.replace(/\#gm\//g,'');
            if (evecl.indexOf(ehash) == -1) {
                a.close();
            }
        }
    };
    window.addEventListener("hashchange", a.hashchange, false);
};
gmFilter.prototype = {
    options: {},
    active_type: "",
    has_sub: false,
    selected: {
        city: "",
        category: "",
        sort: ""
    },
    obj: null,
    scroller: null,
    subscroller: null,
    max_height: 0,
    list_width: 150,
    param: {
        city: "",
        dist_group: "",
        category_id: "",
        tag_id: "",
        sort: ""
    },
    _init: function () {
        var b = this;
        b.param.city = b.options.selected.city || $.query.get("city").toString() || "";
        var h = $.grep(b.options.city, function (i) {
            return i.value === b.param.city
        });
        if (h[0]) {
            b.selected.city = h[0].id;
            b.obj.find(".nav li.city span").text(h[0].name)
        }
        b.param.dist_group = b.options.selected.dist_group || $.query.get("dist_group").toString() || "";
        var d = "";
        var c = $.grep(b.options.city, function (j) {
            if (j.sub_categories) {
                for (var i in j.sub_categories) {
                    if (j.sub_categories[i].param == "dist_group" && j.sub_categories[i].value == b.param.dist_group) {
                        d = j.sub_categories[i].label_name ? j.sub_categories[i].label_name : j.sub_categories[i].name;
                        return true
                    }
                }
            }
            return (j.param == "dist_group" && j.value === b.param.dist_group)
        });
        if (d) {
            b.obj.find(".nav li.city span").text(d)
        }
        b.param.tag_id = b.options.selected.tag || $.query.get("tag_id").toString() || "";
        var g = "";
        var a = $.grep(b.options.category, function (j) {
            if (j.sub_categories) {
                for (var i in j.sub_categories) {
                    if (j.sub_categories[i].param == "tag_id" && j.sub_categories[i].value == b.param.tag_id) {
                        g = j.sub_categories[i].name;
                        return true
                    }
                }
            }
            return (j.param == "tag_id" && j.value === b.param.tag_id)
        });
        b.param.category_id = b.options.selected.category || $.query.get("category_id").toString() || "";
        var f = a[0] ? a : $.grep(b.options.category, function (j) {
            if (j.sub_categories) {
                for (var i in j.sub_categories) {
                    if (j.sub_categories[i].param == "category_id" && j.sub_categories[i].value == b.param.category_id) {
                        return true
                    }
                }
            }
            return (j.param == "category_id" && j.value === b.param.category_id)
        });
        if (f[0]) {
            b.selected.category = f[0].id;
            b.obj.find(".nav li.category span").text((g ? g : f[0].name))
        }
        b.param.sort = b.options.selected.sort || $.query.get("sort").toString() || "";
        var e = $.grep(b.options.sort, function (i) {
            return i.value === b.param.sort
        });
        if (e[0]) {
            b.selected.sort = e[0].id;
            b.obj.find(".nav li.sort span").text(e[0].name)
        }
        b.param.sort_asc = b.options.selected.sort_asc || $.query.get("sort_asc").toString() || "";
        var t = "";
        var e = $.grep(b.options.sort, function (j) {
            if (j.sub_categories) {
                for (var i in j.sub_categories) {
                    if (j.sub_categories[i].param == "sort_asc" && j.sub_categories[i].value == b.param.sort_asc) {
                        t = j.sub_categories[i].label_name ? j.sub_categories[i].label_name : j.sub_categories[i].name;
                        return true
                    }
                }
            }
            return (j.param == "sort_asc" && j.value === b.param.sort_asc)
        });
        if (t) {
            b.obj.find(".nav li.sort span").text(t)
        }
        b._renderDropdownList()
    },
    _renderDropdownList: function () {
        var a = this;
        ["city", "category", "sort"].forEach(function (d) {
            if (a.options[d]) {
                for (var c in a.options[d]) {
                    var f = a.options[d][c];
                    var b = f.id == -5 ? '<span class="font-R">' + f.name + "</span>" : f.name;
                    var e = a._buildLink(f);
                    if (f.sub_categories && f.sub_categories.length) {
                        a.obj.find("." + d + "-wrapper .dropdown-list").append('<li class="listfont"><a href="' + e + '" data-' + d + '-id="' + f.id + '" data-has-sub="true">' + b + '<span class="more">more</span></a></li>')
                    } else {
                        a.obj.find("." + d + "-wrapper .dropdown-list").append('<li class="listfont"><a href="' + e + '" data-' + d + '-id="' + f.id + '">' + b + "</a></li>")
                    }
                }
            }
        })
    },
    _renderDropdownSubList: function (b) {
        var a = this;
        var c = "";
        if (b) {
            b.forEach(function (e) {
                var d = a._buildLink(e);
                c += '<li class="listfont"><a href="' + d + '">' + e.name + "</a></li>"
            })
        }
        a.obj.find("#dropdown-sub-scroller .dropdown-list").html(c).find("a").bind("click", function () {
            a.goclose = true;
            a.close()
        })
    },
    _buildLink: function (c) {
        var a = this;
        var b = location.pathname + "?c=init";
        var u = $("body").attr("data-dourl");
        if (u) {
            b = u;
        }
        ["city", "dist_group", "category_id", "tag_id", "sort", "sort_asc", "ch"].forEach(function (d) {
            if ((c.param == "category_id" && d == "tag_id") || (c.param == "city" && d == "dist_group") || (c.param == "sort" && d == "sort_asc")) {
                return
            }
            if (c.param == "dist_group" && d == "city") {
                var e = $.grep(a.options.city, function (g) {
                    if (g.sub_categories) {
                        for (var f in g.sub_categories) {
                            if (g.sub_categories[f].param == "dist_group" && g.sub_categories[f].value == c.value) {
                                return true
                            }
                        }
                    }
                });
                if (e[0]) {
                    b += "&" + d + "=" + e[0].sub_categories[0].value
                }
            } else if (c.param == "sort_asc" && d == "sort") {
                var e = $.grep(a.options.sort, function (g) {
                    if (g.sub_categories) {
                        for (var f in g.sub_categories) {
                            if (g.sub_categories[f].param == "sort_asc" && g.sub_categories[f].value == c.value) {
                                return true
                            }
                        }
                    }
                });
                if (e[0]) {
                    b += "&" + d + "=" + e[0].sub_categories[0].value
                }
            } else if (c.param == "tag_id" && d == "category_id") {
                var e = $.grep(a.options.category, function (g) {
                    if (g.sub_categories) {
                        for (var f in g.sub_categories) {
                            if (g.sub_categories[f].param == "tag_id" && g.sub_categories[f].value == c.value) {
                                return true
                            }
                        }
                    }
                });
                if (e[0]) {
                    b += "&" + d + "=" + e[0].sub_categories[0].value
                }
            } else {
                if (c.param == d) {
                    if (c.value) {
                        b += "&" + d + "=" + c.value
                    }
                } else {
                    if (a.param[d]) {
                        if (b != "/travel.php?v=idx" || a.param[d] != "Taipei") {
                            b += "&" + d + "=" + a.param[d]
                        }
                    }
                }
            }
        });
        return b
    },
    _resizeDropdownList: function () {
        var a = this;
        if (a.active_type) {
            var c = navigator.userAgent.search("MSIE") > -1;
            var d = a.obj.find(".menubox > ." + a.active_type + "-wrapper").height();
            d = (d > a.options.max_height && !c) ? a.options.max_height : d;
            var b = a.has_sub ? a.list_width : $(window).width();
            a.obj.find(".dropdown-module, #dropdown-scroller, #dropdown-sub-scroller").height(d);
            a.obj.find("#dropdown-scroller").width(b);
            setTimeout(function () {
                if (a.has_sub) {
                    var e = a.obj.find("#dropdown-sub-scroller .dropdown-list").height();
                    e = ($("#dropdown-sub-scroller .dropdown-list").find("li").height() + 2) * $("#dropdown-sub-scroller .dropdown-list").find("li").length;
                    if (e > d && e) {
                        d = e
                    }
                }
                d = (d > a.options.max_height && !c) ? a.options.max_height : d;
                a.obj.find(".dropdown-module, #dropdown-scroller, #dropdown-sub-scroller").height(d);
                if (this.scroller) {
                    this.scroller.destroy()
                }
                this.scroller = new iScroll("dropdown-scroller", {
                    hScroll: false,
                    vScrollbar: false
                });
                if (this.subscroller) {
                    this.subscroller.destroy()
                }
                this.subscroller = new iScroll("dropdown-sub-scroller", {
                    hScroll: false,
                    vScrollbar: false
                })
            }, 200)
        } else {
            setTimeout(function () {
                a.obj.find(".dropdown-module, #dropdown-scroller, #dropdown-sub-scroller").height(0)
            }, 150)
        }
    },
    _reset: function () {
        this.active_type = "";
        this.has_sub = false;
        this.obj.find(".nav li.active").removeClass("active").find("a").removeClass("active");
        this.obj.find(".menubox > li.active").removeClass("active");
        this.obj.find(".shade").remove()
    },
    active: function (b) {
        var a = this;
        a._reset();
        a.active_type = b;
        a.obj.find(".nav li." + b).addClass("active").find("a").addClass("active");
        a.obj.find("." + b + "-wrapper").addClass("active");
        a.obj.find(".dropdown-wrapper").append('<div class="shade" style="height: ' + $(document).height() + 'px;"></div>');
        a.obj.find(".shade").bind("click", function () {
            a.close()
        });
        if (a.selected[b]) {
            a.obj.find("." + b + "-wrapper a[data-" + b + "-id=" + a.selected[b] + "]").trigger("active")
        } else {
            a._resizeDropdownList()
        }
    },
    close: function () {
        if (!this.goclose) {
            var hash = window.location.hash;
            if (/^\#gm\//.test(hash)) {
                window.history.go(-1);
            }
        }
        this._reset();
        this._resizeDropdownList()
    }
};
$().ready(function () {
    var _box = $(".tab_box");
    var _con = $(".tab_con");
    _box.find("div").each(function(index){
        $(this).click(function(){
            $("html, body").animate({scrollTop: $(this).offset().top }, 0)
            var _boxi = parseInt(_box.attr("data-index"));
            _box.attr("data-index", index);
            if ($(this).is(".sel")) return;
            _box.find(">div").removeClass("sel");
            _box.find(">div:eq("+index+")").addClass("sel");
            //
            _con.find(">div").removeClass();
            _con.find(">div:eq("+index+")").addClass((_boxi > index)?"sel-l":"sel-r");
            setTimeout(function(){_con.find(">div:eq("+index+")").addClass("sel");}, 0)
            //
            if (index == 0 && !$(this).attr("data-lazyload")) {
                $(this).attr("data-lazyload", "1")
                _con.find("img").lazyload({effect:"fadeIn"});
            }
        });
    });
    /* 参数筛选 */
    $(".selectattr").click(function () {
        var goodsid = $("#intro").attr("data-id");
        var hash = window.location.hash;
        var href = window.location.href.replace(new RegExp(hash,"g"), "");
        window.location.href = href + '#gc/' + goodsid;
        $(".selectattrval").addClass("show");
        if (!$(this).attr("data-defaultclick")) {
            $(this).attr("data-defaultclick", "1");
            selectattrval_input_click();
        }
    });
    $(".selectattrval").find(".back").click(function () {
        window.history.go(-1);
        /*
        $(".selectattrval").removeClass("show");
        */
    });
    var _cart_hashchange = function(){
        var hash = window.location.hash;
        if (!/^\#gc\//.test(hash)) {
            $(".selectattrval").removeClass("show");
        }
    };
    window.addEventListener("hashchange", _cart_hashchange, false);
    var selectattrval_input_click = function() {
        var price = 0;
        var _n = false;
        $(".sku-control").find("input").each(function(){
            if ($(this).attr("checked")){
                if ($(this).attr("data-price")!="") price+= runNum($(this).attr("data-price"));
            }
        });
        $(".selectprice").text("￥"+runNum(runNum($(".selectprice").attr("data-price"))+price));
        //动态取库存
        var attrval = '';
        $(".sku-control").find("ul li").each(function(){
            _n = false;
            $(this).find("input").each(function(){
                if ($(this).attr("checked")) {
                    _n = true;
                    attrval+= $(this).val();
                }
            });
            if (!_n) return false;
        });
        if (_n) {
            $.alert("请稍等...",0,1)
            $.ajax({
                type: "POST",
                url: $("#intro").attr("data-url")+"&do=stock&id="+$("#intro").attr("data-id"),
                data: "val="+attrval,
                dataType: "json",
                success: function (data) {
                    $.alert(0)
                    if (data.success == "1"){
                        $(".selectattrval").find("#quantity").attr("max", data.num).keyup();
                        $(".selectattrval").find(".goodsv").html(data.goodsv);
                        if (data.num > 0){
                            $("button#buynow").removeClass("be");
                        }else{
                            $("button#buynow").addClass("be");
                        }
                    }
                },
                error : function () {
                    window.location.reload();
                }
            });
        }
    }
    $(".selectattrval").find("input").click(function () {
        selectattrval_input_click();
    });
    /* 购买数量操作 */
    $(".selectattrval").find(".decrease").click(function () {
        var _num = runNum($(this).next("input").val());
        if (_num > 1) {
            $(this).next("input").val(_num - 1);
        }
    });
    $(".selectattrval").find(".increase").click(function () {
        var _num = runNum($(this).prev("input").val());
        if (_num < runNum($(this).prev("input").attr("max"))) {
            $(this).prev("input").val(_num + 1);
        }else{
            $.alertk("已经达到购买数量极限！");
        }
    });
    $(".selectattrval").find("#quantity").keyup(function(){
        var _num = runNum($(this).val());
        var _max = runNum($(this).attr("max"));
        if (_num < 1) $(this).val(1);
        if (_num > _max) $(this).val(_max);
    });
    /* 点击购买 */
    $("a#buynow,button#buynow").click(function () {
        var _type = $(this).attr("data-type");
        var _n = false;
        var _t = "";
        var _s = "dosubmit=put&goods_id=" + runNum($("#intro").attr("data-id")) + "&carttype=" + _type;
        if ($(".sku-control").length > 0){
            if ($(this).is("a")){
                $(".selectattr").click();
                return;
            }
            if (runNum($(".selectattrval").find("#quantity").attr("max")) < 1){
                $.alertk("你的选择不符合！");
                return;
            }
            _s+= "&attr=";
            $(".sku-control").find("ul li").each(function(){
                _n = false;
                _t = $(this).find("h2").text();
                $(this).find("input").each(function(){
                    if ($(this).attr("checked")) {
                        _n = true;
                        _s+= "{**}"+_t+"{::}"+$(this).val()+"{||}";
                    }
                });
                if (!_n) return false;
            });
            if (!_n) {
                if ($(".selectattrval").is(":hidden")){
                    $(".selectattr").click();
                }
                $.alertk("请选择" + _t);
                return ;
            }
            _s+= "&number=" + runNum($(".selectattrval").find("#quantity").val());
        }
        $.alert("请稍等...",0,1)
        $.ajax({
            type: "POST",
            url: $("#intro").attr("data-url")+"&do=cart",
            data: _s,
            dataType: "json",
            success: function (data) {
                if (data.success == "1"){
                    window.location.href = $("#intro").attr("data-url")+"&do=buy&id="+data.id;
                }else{
                    $.alertk(data.message);
                    if (data.cartnum || data.cartnum === 0) {
                        var _a_shop = $("a#a_shop").find("em");
                        _a_shop.text(data.cartnum).hide();
                        if (data.cartnum > 0) _a_shop.show();
                    }
                }
            },
            error: function (msg) {
                $.alertk("提交数据出错！");
            }
        });
    });
    _comment();
    _paycart();
});


function runNum(str) {
    var _s = Number(str);
    if (_s+"" == "NaN") {
        _s = 0;
    }
    return _s;
}

function runNull(str) {
    _s = str+"";
    if (_s == "null") {
        _s = "";
    }
    return _s;
}
//
window.cpage = 0;
function _comment(obj) {
    if (!$(obj).is(".c-on") && obj) return;
    if ($(obj).attr("id") == 'prevpage'){
        window.cpage--;
    }else{
        window.cpage++;
    }
    var _url = $("body").attr("data-url");
    var _goodsid = $("body").attr("data-goodsid");
    //
    $.getJSON(_url+"&do=comment&id="+_goodsid+"&page="+window.cpage, function(json){
        var eve = $("#commentlist");
        if (json.prev) {
            eve.find("#prevpage").addClass("c-on");
        }else{
            eve.find("#prevpage").removeClass("c-on");
        }
        if (json.next) {
            eve.find("#nextpage").addClass("c-on");
        }else{
            eve.find("#nextpage").removeClass("c-on");
        }
        eve.find("#textpage").text(json.nowpage+"/"+json.totalpage);
        if (json.totalpage > 1) eve.find(".pagebut").show();
        var ljson = eval(json.list)
        var _html = "<ul>";
        for(var i=0; i<ljson.length; i++) {
            var attr = runNull(ljson[i].attr);
            attr = attr.replace(/<br\/>/g,'，');
            attr = attr.replace(/null/g,'');
            var content = runNull(ljson[i].content);
            if (!content) content = "(空)";
            _html+= '<li>' +
                '<div class="anonyname">'+'<em>'+runNull(ljson[i].score)+'分</em>'+runNull(ljson[i].anonyname)+'</div>' +
                '<div class="content">'+content+'</div>' +
                '<div class="date">'+getLocalTime(runNull(ljson[i].indate))+' '+attr+'</div>' +
                '</li>';
        }
        if (!ljson.length) {
            _html+= '<li class="nolist">没有查询到记录!</li>'
        }
        _html+= '</ul>';
        eve.find(".pagecon").html(_html);
    });
}

window.ppage = 0;
function _paycart(obj) {
    if (!$(obj).is(".c-on") && obj) return;
    if ($(obj).attr("id") == 'prevpage'){
        window.ppage--;
    }else{
        window.ppage++;
    }
    var _url = $("body").attr("data-url");
    var _goodsid = $("body").attr("data-goodsid");
    //
    $.getJSON(_url+"&do=paycart&id="+_goodsid+"&page="+window.ppage,function(json){
        var eve = $("#paylist");
        if (json.prev) {
            eve.find("#prevpage").addClass("c-on");
        }else{
            eve.find("#prevpage").removeClass("c-on");
        }
        if (json.next) {
            eve.find("#nextpage").addClass("c-on");
        }else{
            eve.find("#nextpage").removeClass("c-on");
        }
        eve.find("#textpage").text(json.nowpage+"/"+json.totalpage);
        if (json.totalpage > 1) eve.find(".pagebut").show();
        var ljson = eval(json.list)
        var _html = "<ul>";
        for(var i=0; i<ljson.length; i++) {
            _html+= '<li>' +
                '<div class="anonyname">'+runNull(ljson[i].anonyname)+'</div>' +
                '<div class="attr">'+runNull(ljson[i].attr)+'</div>' +
                '<div class="price">￥'+runNull(ljson[i].price)+'</div>' +
                '<div class="number">X '+runNull(ljson[i].number)+'</div>' +
                '<div class="date">付款时间：'+getLocalTime(ljson[i].update)+'</div>' +
                '</li>';
        }
        if (!ljson.length) {
            _html+= '<li class="nolist">没有查询到记录!</li>'
        }
        _html+= '</ul>';
        eve.find(".pagecon").html(_html);
    });
}

function getLocalTime(nS) {
    var dateObj = new Date(nS * 1000);
    return dateObj.getFullYear() + '-' + (dateObj.getMonth() + 1) + '-' +
        dateObj.getDate() + ' ' + dateObj.getHours() + ':' + dateObj.getMinutes() + ':' + dateObj.getSeconds();
}

/*document.addEventListener("DOMContentLoaded", loaded, !1);*/